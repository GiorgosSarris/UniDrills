chat.h

Το αρχείο chat.h περιέχει όλους τους ορισμούς που χρησιμοποιούνται από το chat.c. Σε αυτό ορίζονται οι σταθερές του συστήματος, οι δομές δεδομένων που αποθηκεύονται στην κοινόχρηστη μνήμη και τα prototypes των συναρτήσεων.

Οι σταθερές καθορίζουν τα μέγιστα όρια του συστήματος, όπως τον αριθμό διαλόγων, τον αριθμό μηνυμάτων, τους συμμετέχοντες ανά διάλογο και το μέγιστο μέγεθος μηνύματος. Τα όρια αυτά χρησιμοποιούνται σε όλο τον κώδικα για να γίνεται στατική δέσμευση μνήμης και απλός έλεγχος ορίων.

Η δομή Message περιγράφει την αναπαράσταση ενός μηνύματος μέσα στην κοινόχρηστη μνήμη. Περιέχει τον διάλογο στον οποίο ανήκει, το PID του αποστολέα, το περιεχόμενο του μηνύματος και πληροφορία για το ποιοι συμμετέχοντες το έχουν ήδη διαβάσει. Τα πεδία αυτά χρησιμοποιούνται από τον κώδικα λήψης ώστε κάθε διεργασία να εμφανίζει κάθε μήνυμα μία φορά.

Η δομή Dialog αποθηκεύει την κατάσταση ενός διαλόγου. Περιλαμβάνει το αναγνωριστικό του διαλόγου, τη λίστα των συμμετεχόντων, τον αριθμό ενεργών διεργασιών και flags που χρησιμοποιούνται για τον συγχρονισμένο τερματισμό όλων των διεργασιών που συμμετέχουν στον ίδιο διάλογο.

Η δομή SharedData αποτελεί το σύνολο της κοινόχρηστης κατάστασης του συστήματος. Περιέχει όλους τους διαλόγους και όλα τα μηνύματα και είναι η μοναδική δομή που αποθηκεύεται στο shared memory segment και προσπελαύνεται από όλες τις διεργασίες.

Τέλος, στο chat.h δηλώνονται τα prototypes όλων των συναρτήσεων που υλοποιούνται στο chat.c, ώστε να υπάρχει καθαρός διαχωρισμός μεταξύ ορισμών και υλοποίησης και να επιτρέπεται η σωστή μεταγλώττιση του προγράμματος.

chat.c

Το chat.c περιέχει όλη τη λειτουργικότητα της εφαρμογής. Αρχικά δημιουργούνται ή συνδέονται οι μηχανισμοί IPC (shared memory και semaphore) και γίνεται χαρτογράφηση της κοινόχρηστης μνήμης στον χώρο διευθύνσεων της διεργασίας. Αν το segment δημιουργείται για πρώτη φορά, όλα τα πεδία της κοινόχρηστης δομής μηδενίζονται ώστε να ξεκινήσει το σύστημα σε καθαρή κατάσταση.

Η πρόσβαση στην κοινόχρηστη μνήμη γίνεται αποκλειστικά μέσα σε κρίσιμες περιοχές, οι οποίες προστατεύονται από semaphore. Πριν από κάθε ανάγνωση ή εγγραφή σε διαλόγους, συμμετέχοντες ή μηνύματα, γίνεται lock και μετά το τέλος της ενέργειας γίνεται unlock, ώστε να αποφεύγονται ασυνέπειες δεδομένων μεταξύ ταυτόχρονων διεργασιών.

Κατά την είσοδο μιας διεργασίας σε διάλογο, ο κώδικας ελέγχει αν ο διάλογος υπάρχει ήδη. Αν δεν υπάρχει, δεσμεύεται νέα θέση στον πίνακα διαλόγων και αρχικοποιείται. Στη συνέχεια το PID της διεργασίας προστίθεται στη λίστα συμμετεχόντων και ενημερώνεται ο αριθμός ενεργών συμμετεχόντων του διαλόγου.

Η αποστολή μηνύματος υλοποιείται με αναζήτηση κενής θέσης στον πίνακα μηνυμάτων της κοινόχρηστης μνήμης. Όταν βρεθεί διαθέσιμη εγγραφή, συμπληρώνονται τα πεδία του μηνύματος (διάλογος, αποστολέας, περιεχόμενο) και το μήνυμα σηματοδοτείται ως έγκυρο. Η λειτουργία αυτή γίνεται αποκλειστικά εντός κρίσιμης περιοχής.

Η λήψη μηνυμάτων πραγματοποιείται με σάρωση όλων των ενεργών μηνυμάτων. Για κάθε μήνυμα ελέγχεται αν ανήκει στον τρέχοντα διάλογο και αν το PID της διεργασίας δεν έχει ήδη καταγραφεί ως αναγνώστης. Αν το μήνυμα είναι νέο για τη διεργασία, εμφανίζεται στην οθόνη και καταγράφεται ότι διαβάστηκε. Όταν ένα μήνυμα διαβαστεί από όλους τους συμμετέχοντες του διαλόγου, διαγράφεται από την κοινόχρηστη μνήμη.

Για την ταυτόχρονη αποστολή και λήψη μηνυμάτων χρησιμοποιείται fork. Η μία διεργασία παραμένει υπεύθυνη για την είσοδο χρήστη και την αποστολή μηνυμάτων, ενώ η δεύτερη εκτελεί συνεχώς έλεγχο για νέα μηνύματα και για σήματα τερματισμού. Οι δύο διεργασίες μοιράζονται την ίδια κοινόχρηστη μνήμη αλλά εκτελούνται ανεξάρτητα.

Ο τερματισμός ενός διαλόγου υλοποιείται μέσω ειδικού flag στην κοινόχρηστη μνήμη. Όταν κάποια διεργασία στείλει εντολή τερματισμού, το flag ενεργοποιείται και όλες οι διεργασίες που ανήκουν στον ίδιο διάλογο το ανιχνεύουν και τερματίζουν τα loop εκτέλεσής τους.

Κατά την έξοδο μιας διεργασίας, αφαιρείται από τη λίστα συμμετεχόντων του διαλόγου. Αν δεν απομένουν άλλες ενεργές διεργασίες, οι πόροι IPC αποδεσμεύονται και το shared memory και το semaphore διαγράφονται, ώστε να μην παραμένουν ανενεργοί πόροι στο σύστημα.

Makefile

Το Makefile χρησιμοποιείται για τη μεταγλώττιση της εφαρμογής και την αυτόματη δημιουργία του εκτελέσιμου αρχείου, απλοποιώντας τη διαδικασία build με μία εντολή.
